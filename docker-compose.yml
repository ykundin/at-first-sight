version: "3.3"
services:
  reverse-proxy:
    image: traefik:v2.10
    ports:
      - 80:80
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./reverse-proxy/traefik.yml:/traefik.yml:ro
      - ./reverse-proxy/letsencrypt:/letsencrypt
    labels:
      - traefik.enable=true
      - traefik.http.routers.traefik.entrypoints=web
      - traefik.http.routers.traefik.rule=Host(`traefik.kundin.pro`)
      # - traefik.http.routers.traefik.tls=true
      # - traefik.http.routers.traefik.tls.certresolver=letsEncryptStaging
      - traefik.http.routers.traefik.service=api@internal

  db:
    image: mongo:5.0.2
    restart: always
    env_file:
      - .env
    ports:
      - 27017:27017
    volumes:
      - db_prod_data:/data/db
      - ./mongo/docker-entrypoint-initdb.d:/docker-entrypoint-initdb.d:ro

  object-storage:
    image: bitnami/minio:latest
    restart: always
    env_file:
      - .env
    volumes:
      - minio_prod_storage:/data
    labels:
      - traefik.enable=true
      - traefik.http.routers.s3.entrypoints=web-secure
      - traefik.http.routers.s3.rule=Host(`s3.kundin.pro`)
      - traefik.http.routers.s3.service=object-storage
      - traefik.http.routers.s3.tls=true
      - traefik.http.routers.s3.tls.certresolver=letsEncryptStaging
      - traefik.http.services.object-storage.loadbalancer.server.port=9001

  imgproxy:
    image: darthsim/imgproxy
    env_file:
      - .env
    environment:
      - IMGPROXY_USE_S3=true
      - IMGPROXY_S3_ENDPOINT=http://object-storage:9000

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    restart: always
    working_dir: /app
    env_file:
      - .env
    environment:
      - PORT=4000
      - AWS_ENDPOINT=http://object-storage:9000
    labels:
      - traefik.enable=true
      - traefik.http.routers.backend.entrypoints=web
      - traefik.http.routers.backend.rule=Host(`kundin.pro`) && PathPrefix(`/api`, `/webhook`)
      - traefik.http.routers.backend.service=backend
      - traefik.http.routers.backend.tls=true
      - traefik.http.routers.backend.tls.certresolver=letsEncryptStaging
      - traefik.http.services.backend.loadbalancer.server.port=4000

  tg-web-app:
    build:
      context: ./tg-web-app
      dockerfile: Dockerfile
      args:
        - PORT=3000
        - IMGPROXY_URL=http://imgproxy:8080
    restart: always
    working_dir: /app
    env_file:
      - .env
    environment:
      - PORT=3000
      - IMGPROXY_URL=http://imgproxy:8080
    labels:
      - traefik.enable=true
      - traefik.http.routers.tg-web-app.entrypoints=web-secure
      - traefik.http.routers.tg-web-app.rule=Host(`kundin.pro`)
      - traefik.http.routers.tg-web-app.tls=true
      - traefik.http.routers.tg-web-app.tls.certresolver=letsEncryptStaging
      - traefik.http.routers.tg-web-app.service=tg-web-app
      - traefik.http.services.tg-web-app.loadbalancer.server.port=4173

volumes:
  db_prod_data:
  minio_prod_storage:
